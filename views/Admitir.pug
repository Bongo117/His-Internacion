extends layout

block content
  .fondo-admisiones
  .contenido-box
    h1.text-success.mb-4= titulo
    //- --- SECCI√ìN DE EMERGENCIA (SHOCKROOM) ---
    .card.mb-5.border-danger.shadow
        .card-header.bg-danger.text-white.d-flex.justify-content-between.align-items-center
            strong üö® PROTOCOLO DE EMERGENCIA (SHOCKROOM)
            span.badge.bg-white.text-danger Prioridad Alta
        .card-body.bg-light
            p.mb-2.small.text-danger 
                strong ‚ö†Ô∏è ATENCI√ìN: 
                | Utilice esta opci√≥n √öNICAMENTE cuando el paciente no pueda ser identificado y requiera internaci√≥n inmediata. Se generar√° una identidad temporal (NN).
            
            form.row.g-3(method="POST", action="/admitir/emergencia")
                .col-md-5
                    label.form-label.fw-bold(for="cama_urgencia") üõèÔ∏è Asignar Cama U.T.I / Guardia
                    select.form-select#cama_urgencia(name="id_cama_asignada", required)
                        option(value="") -- Seleccionar Cama Libre --
                        each cama in camas
                            option(value=cama.id_cama)= `Cama ${cama.numero} (Hab. ${cama.habitacion_numero})`
                
                .col-md-5
                    label.form-label.fw-bold(for="motivo_urgencia") üìù Motivo de Ingreso (Breve)
                    input.form-control#motivo_urgencia(type="text", name="motivo", placeholder="Ej: Politraumatismo, ACV, Inconsciente...", required)

                .col-md-2.d-flex.align-items-end
                    button.btn.btn-danger.w-100.fw-bold(type="submit") ‚ö° INGRESAR YA

    if error
      div.alert.alert-warning= error

    .card.shadow-sm
      .card-header.bg-primary.text-white
        strong üìã Admisi√≥n Administrativa / Programada
      .card-body
        form(method="POST" action="/admitir")
            .row.g-3
                //- 1. Selecci√≥n de Paciente
                .col-md-6
                    label.form-label Paciente Registrado
                    select.form-select#id_paciente(name="id_paciente" required onchange="mostrarDatosPaciente()")
                        option(value="") -- Buscar por Nombre/DNI --
                        each p in pacientes
                            option(value=p.id_paciente data-dni=p.dni data-fnac=p.fecha_nacimiento data-tel=p.telefono) #{p.apellido}, #{p.nombre} (DNI: #{p.dni})
                    
                    //- Ficha t√©cnica r√°pida (Visual feedback)
                    div#datosPaciente.alert.alert-info.mt-2.d-none
                        small
                            strong DNI: 
                            span#dp_dni -
                            |  | 
                            strong Nacimiento: 
                            span#dp_fnac -
                            |  | 
                            strong Tel: 
                            span#dp_tel -

                //- 2. Cama Destino
                .col-md-6
                    label.form-label Cama Asignada
                    select.form-select(name="id_cama_asignada" required)
                        option(value="") -- Seleccionar Cama Libre --
                        each cama in camas
                           option(value=cama.id_cama)= `Cama ${cama.numero} (Hab. ${cama.habitacion_numero})`

                //- 3. Tipo de Ingreso (El Selector Clave)
                .col-md-4
                    label.form-label Tipo de Ingreso
                    select.form-select#select_tipo(name="tipo_ingreso" required onchange="cambiarFormulario()")
                        option(value="consulta") Consulta / Guardia Com√∫n
                        option(value="derivado") üöë Derivaci√≥n (Traslado)
                        option(value="quirurgico") üî™ Quir√∫rgico / Programado
                        option(value="emergencia") üö® Emergencia (Con DNI)

                .col-md-8
                    label.form-label Motivo Principal
                    input.form-control(type="text" name="motivo" required placeholder="Ej: Neumon√≠a bilateral, Apendicitis...")

                //- --- CAMPOS LOG√çSTICOS CONTEXTUALES (Ocultos por defecto) ---
                
                //- A. Solo para Derivados
                div#extra_derivado.col-12.d-none.p-3.bg-light.border.rounded
                    label.form-label.fw-bold üè• Datos de Traslado (Log√≠stica)
                    input.form-control(type="text" name="institucion_procedencia" placeholder="¬øDe qu√© hospital o cl√≠nica proviene? (Ej: Hospital Italiano)")
                    small.text-muted * Requerido para gestionar el retorno o auditor√≠a de traslado.

                //- B. Solo para Quir√∫rgicos
                div#extra_quirurgico.col-12.d-none.p-3.bg-light.border.rounded
                    label.form-label.fw-bold üî™ Planificaci√≥n Quir√∫rgica
                    input.form-control(type="text" name="cirugia_programada" placeholder="Procedimiento a realizar (Ej: Colecistectom√≠a Laparosc√≥pica)")
                    div.form-check.mt-2
                        input.form-check-input(type="checkbox" id="ayuno")
                        label.form-check-label(for="ayuno") Paciente cumple horas de ayuno pre-quir√∫rgico

            .d-grid.mt-4
                button.btn.btn-primary.btn-lg(type="submit") üíæ Confirmar Internaci√≥n

    br
    a.btn.btn-link(href="/") Volver al inicio

  //- Script para manejar la l√≥gica visual
  script.
    // Mostrar datos del paciente al seleccionar
    function mostrarDatosPaciente() {
      const select = document.getElementById('id_paciente');
      const selected = select.options[select.selectedIndex];
      const divDatos = document.getElementById('datosPaciente');

      if (selected.value === '') {
        divDatos.classList.add('d-none');
        return;
      }
      divDatos.classList.remove('d-none');
      document.getElementById('dp_dni').textContent  = selected.dataset.dni || '-';
      // Formatear fecha
      const d = new Date(selected.dataset.fnac);
      document.getElementById('dp_fnac').textContent = d.toLocaleDateString();
      document.getElementById('dp_tel').textContent  = selected.dataset.tel || '-';
    }

    // L√≥gica Contextual: Mostrar campos seg√∫n el tipo
    function cambiarFormulario() {
        const tipo = document.getElementById('select_tipo').value;
        const divDerivado = document.getElementById('extra_derivado');
        const divQuirurgico = document.getElementById('extra_quirurgico');

        // Resetear visibilidad
        divDerivado.classList.add('d-none');
        divQuirurgico.classList.add('d-none');
        
        // Limpiar inputs para no enviar basura si cambia de opini√≥n
        divDerivado.querySelector('input').value = '';
        divQuirurgico.querySelector('input').value = '';

        if (tipo === 'derivado') {
            divDerivado.classList.remove('d-none');
            divDerivado.querySelector('input').required = true; // Hacerlo obligatorio din√°micamente
        } else if (tipo === 'quirurgico') {
            divQuirurgico.classList.remove('d-none');
            divQuirurgico.querySelector('input').required = true;
        }
    }
