extends layout

block content
  .fondo-admisiones
  .contenido-box
    h2.text-danger.mb-4 üÜî Fusi√≥n de Identidad

    //- Advertencia
    .alert.alert-warning.shadow-sm
        h5 ‚ö†Ô∏è Fusi√≥n de Historia Cl√≠nica
        p
            | La admisi√≥n actual del paciente NN 
            strong (ID: #{pacienteNN.id_admision}) 
            | ser√° transferida al paciente real que selecciones abajo.

    //- Datos del NN (Origen)
    .card.mb-4.border-warning
        .card-header.bg-warning.text-dark 
            strong üë§ Paciente NN Actual
        .card-body
            ul.mb-0
                li #[strong Nombre Temp:] #{pacienteNN.nombre} #{pacienteNN.apellido}
                li #[strong DNI Temp:] #{pacienteNN.dni}
                li #[strong Ingreso:] #{new Date(pacienteNN.fecha_admision).toLocaleString()}

    hr

    h3.text-primary üîé Buscar Paciente Real (Destino)
    
    //- BUSCADOR INTERACTIVO
    .mb-3.position-relative
        label.form-label Escriba Nombre, Apellido o DNI:
        input#buscador.form-control.form-control-lg(type="text" placeholder="Ej: Perez, Juan, o 33000..." autocomplete="off")
        
        //- Contenedor de resultados (se llena con JS)
        div#listaResultados.list-group.mt-1.shadow(style="position: absolute; width: 100%; z-index: 1000; max-height: 200px; overflow-y: auto; display: none;")

    //- FORMULARIO FINAL (Se muestra al seleccionar)
    #confirmacion.card.border-success.d-none
        .card-header.bg-success.text-white
            strong ‚úÖ Paciente Seleccionado
        .card-body.text-center
            h3#nombreSeleccionado.text-success
            p.text-muted DNI: #[span#dniSeleccionado]
            
            //- Formulario principal que se enviar√°
            //- CAMBIO: action debe ser "/identificar" (sin /admisiones)
            form(method="POST" action="/identificar" id="form_identificar")
                input(type="hidden" name="id_admision" value=pacienteNN.id_admision)
                input#inputDniReal(type="hidden" name="dni_real")
                
                button.btn.btn-success.btn-lg.w-100(type="submit", onclick="return confirm('¬øCONFIRMA LA FUSI√ìN? Esta acci√≥n es irreversible.')") 
                    | üîÑ CONFIRMAR FUSI√ìN

  //- SCRIPT DEL CLIENTE (AJAX)
  script.
    const inputBuscador = document.getElementById('buscador');
    const listaResultados = document.getElementById('listaResultados');
    const panelConfirmacion = document.getElementById('confirmacion');
    const nombreSel = document.getElementById('nombreSeleccionado');
    const dniSel = document.getElementById('dniSeleccionado');
    const inputHidden = document.getElementById('inputDniReal');

    // Escuchar cuando el usuario escribe
    inputBuscador.addEventListener('input', async (e) => {
        const termino = e.target.value;

        if (termino.length < 2) { // Buscar solo si hay 2+ letras
            listaResultados.style.display = 'none';
            return;
        }

        // Llamada AJAX al Backend
        try {
            const res = await fetch(`/pacientes/api/smart-search?termino=${termino}`);
            const pacientes = await res.json();

            // Limpiar lista vieja
            listaResultados.innerHTML = '';

            if (pacientes.length === 0) {
                listaResultados.innerHTML = '<div class="list-group-item">No se encontraron resultados.</div>';
            } else {
                // Dibujar cada paciente encontrado
                pacientes.forEach(p => {
                    const item = document.createElement('button');
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <div>
                            <strong>${p.apellido}, ${p.nombre}</strong>
                            <br><small class="text-muted">DNI: ${p.dni}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">Seleccionar</span>
                    `;
                    
                    // Al hacer clic en un paciente
                    item.onclick = () => {
                        seleccionarPaciente(p);
                    };

                    listaResultados.appendChild(item);
                });
            }
            listaResultados.style.display = 'block';

        } catch (error) {
            console.error('Error buscando:', error);
        }
    });

    function seleccionarPaciente(p) {
        // 1. Ocultar lista
        listaResultados.style.display = 'none';
        inputBuscador.value = ''; // Limpiar buscador

        // 2. Llenar la tarjeta de confirmaci√≥n
        nombreSel.textContent = `${p.apellido}, ${p.nombre}`;
        dniSel.textContent = p.dni;
        inputHidden.value = p.dni; // <--- ESTO ES LO QUE SE ENV√çA AL SERVER

        // 3. Mostrar confirmaci√≥n
        panelConfirmacion.classList.remove('d-none');
    }